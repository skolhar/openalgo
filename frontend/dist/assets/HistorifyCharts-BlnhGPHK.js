import{r as t,j as e}from"./vendor-react-Oj_OEjND.js";import{u as xe,d as qe,s as C,B as p,e as R,c as J,D as Qe,x as Je,y as Ge,z as Ze,C as G,E as Ke,L as Xe,G as es}from"./index-DLC6Cz1G.js";import{C as L,d as I}from"./card-DYajf7Ei.js";import{P as ss,a as ts,b as as,C as rs,c as ns,d as os,e as ls,f as cs,g as is}from"./popover-BB8_McZj.js";import{I as Z}from"./input-BO5SSqqX.js";import{S as ge,a as fe,b as pe,c as je,d as j}from"./select-B0lzanXN.js";import{q as ds,K as ms,W as us,R as hs,V as xs}from"./lightweight-charts.production-EcMg1Lek.js";import{N as gs,D as ve,S as fs,as as ps,Y as js,Z as Se,i as be,L as vs,q as Ss,r as bs,aR as Ns,aS as ws,R as ys,p as Cs,s as Ds}from"./vendor-icons-CM9yieS6.js";import{a as Ms,d as Ls,c as Is,L as K}from"./vendor-router-DvoFlIsv.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-radix-C5Vc2Qbp.js";function Ps(){const O=Ms(),{mode:U,toggleMode:Ne,appMode:h,toggleAppMode:we,isTogglingMode:X}=xe(),{user:A,logout:ee}=qe(),i=U==="dark"||h==="analyzer",[ye,se]=t.useState(!1),{symbol:Ce}=Ls(),[te,ae]=Is(),De=async()=>{try{await es.logout(),ee(),O("/login"),C.success("Logged out successfully","historify")}catch{ee(),O("/login")}},re=async()=>{const s=await we();if(s.success){const a=xe.getState().appMode;C.success(`Switched to ${a==="live"?"Live":"Analyze"} mode`,"historify")}else C.error(s.message||"Failed to toggle mode","historify")},[D,Me]=t.useState([]),[ne,oe]=t.useState(!1),[V,P]=t.useState(!1),[o,Le]=t.useState(Ce||""),[l,Ie]=t.useState(te.get("exchange")||"NSE"),[m,Te]=t.useState(te.get("interval")||"D"),[ke,le]=t.useState(!1),[T,ce]=t.useState(""),[x,ie]=t.useState(!1),[k,ze]=t.useState("25"),[d,Ee]=t.useState("m"),[H,$e]=t.useState(()=>{const s=new Date;return s.setMonth(s.getMonth()-6),s.toISOString().split("T")[0]}),[W,Fe]=t.useState(()=>new Date().toISOString().split("T")[0]),[r,Re]=t.useState([]),[z,Oe]=t.useState(null),g=t.useRef(null),u=t.useRef(null),Ue=t.useRef(null),Ae=t.useRef(null),Ve=["1m","2m","3m","5m","10m","15m","30m","1h","2h","4h","D","W","M","Q","Y"],S=t.useMemo(()=>{if(x){if(["W","M","Q","Y"].includes(d)){const s=parseInt(k,10)||1;return s===1?d:`${s}${d}`}return`${k}${d}`}return m},[x,k,d,m]),de=t.useMemo(()=>!!(["1s","5s","10s","15s","30s","1m","2m","3m","5m","10m","15m","30m","1h","2h","4h"].includes(S)||x&&["m","h"].includes(d)),[S,x,d]),Y=t.useMemo(()=>{const s=new Map;return D.forEach(a=>{const c=`${a.symbol}:${a.exchange}`;s.has(c)?s.get(c).intervals.push(a.interval):s.set(c,{symbol:a.symbol,exchange:a.exchange,intervals:[a.interval]})}),Array.from(s.values())},[D]),Pe=t.useMemo(()=>{if(!T)return Y;const s=T.toLowerCase();return Y.filter(a=>a.symbol.toLowerCase().includes(s)||a.exchange.toLowerCase().includes(s))},[Y,T]);t.useEffect(()=>{He()},[]),t.useEffect(()=>{o&&l&&m&&ae({exchange:l,interval:m})},[o,l,m,ae]),t.useEffect(()=>{o&&l&&S&&(me(),We())},[o,l,S]),t.useEffect(()=>{if(!g.current)return;const s=setTimeout(()=>{if(!g.current)return;u.current&&(u.current.remove(),u.current=null);const b=g.current,E=b.offsetWidth||800,$=b.offsetHeight||600,_=de,ue=x&&["W","M","Q","Y"].includes(d),Be=M=>{const N=new Date(M*1e3),n=ue?0:5.5*60*60*1e3,v=new Date(N.getTime()+n),f=v.getUTCDate().toString().padStart(2,"0"),w=(v.getUTCMonth()+1).toString().padStart(2,"0"),y=v.getUTCFullYear().toString().slice(-2),q=v.getUTCHours().toString().padStart(2,"0"),Q=v.getUTCMinutes().toString().padStart(2,"0");return _?`${f}/${w}/${y} ${q}:${Q}`:`${f}/${w}/${y}`},F=ds(b,{width:E,height:Math.max($,500),layout:{background:{type:us.Solid,color:"transparent"},textColor:i?"#a6adbb":"#333"},grid:{vertLines:{color:i?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"},horzLines:{color:i?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"}},localization:{timeFormatter:Be},rightPriceScale:{borderColor:i?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",scaleMargins:{top:.1,bottom:.25}},timeScale:{borderColor:i?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",timeVisible:_,secondsVisible:!1,tickMarkFormatter:(M,N)=>{const n=new Date(M*1e3),v=ue?0:5.5*60*60*1e3,f=new Date(n.getTime()+v);if(_){const w=f.getUTCHours().toString().padStart(2,"0"),y=f.getUTCMinutes().toString().padStart(2,"0");return`${w}:${y}`}else{const w=f.getUTCDate(),y=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],q=f.getUTCMonth(),Q=f.getUTCFullYear();return N===0?Q.toString():N===1?y[q]:w.toString()}}},crosshair:{mode:ms.Normal,vertLine:{width:1,color:i?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelVisible:!0,labelBackgroundColor:i?"#1f2937":"#374151"},horzLine:{width:1,color:i?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelBackgroundColor:i?"#1f2937":"#374151"}}}),he=F.addSeries(hs,{upColor:"#22c55e",downColor:"#ef4444",borderVisible:!1,wickUpColor:"#22c55e",wickDownColor:"#ef4444"}),B=F.addSeries(xs,{color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:""});if(B.priceScale().applyOptions({scaleMargins:{top:.8,bottom:0}}),u.current=F,Ue.current=he,Ae.current=B,r.length>0){const M=r.map(n=>({time:n.timestamp,open:n.open,high:n.high,low:n.low,close:n.close}));he.setData(M);const N=r.map(n=>({time:n.timestamp,value:n.volume,color:n.close>=n.open?"rgba(34, 197, 94, 0.5)":"rgba(239, 68, 68, 0.5)"}));B.setData(N),F.timeScale().fitContent()}},100),a=()=>{if(u.current&&g.current){const b=g.current,E=b.offsetWidth,$=b.offsetHeight;E>0&&$>0&&u.current.applyOptions({width:E,height:$})}},c=new ResizeObserver(a);return g.current&&c.observe(g.current),window.addEventListener("resize",a),()=>{clearTimeout(s),c.disconnect(),window.removeEventListener("resize",a),u.current&&(u.current.remove(),u.current=null)}},[i,r,V,de,x,d]);const He=async()=>{try{const a=await(await fetch("/historify/api/catalog",{credentials:"include"})).json();a.status==="success"&&Me(a.data||[])}catch{}},me=t.useCallback(async()=>{if(!(!o||!l)){oe(!0);try{const s=new URLSearchParams({symbol:o,exchange:l,interval:S,start_date:H,end_date:W}),c=await(await fetch(`/historify/api/data?${s}`,{credentials:"include"})).json();c.status==="success"?(Re(c.data||[]),c.count===0&&C.info("No data available for this range. Make sure 1m data is downloaded for custom intervals.","historify")):C.error(c.message||"Failed to load chart data","historify")}catch{C.error("Failed to load chart data","historify")}finally{oe(!1)}}},[o,l,S,H,W]),We=t.useCallback(()=>{const s=D.find(a=>a.symbol===o&&a.exchange===l&&a.interval===m);Oe(s||null)},[D,o,l,m]),Ye=(s,a)=>{Le(s),Ie(a),le(!1),ce("")},_e=()=>{document.fullscreenElement?(document.exitFullscreen(),P(!1)):(document.documentElement.requestFullscreen(),P(!0))};return t.useEffect(()=>{const s=()=>{P(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs("div",{className:J("h-full flex flex-col bg-background text-foreground",V&&"fixed inset-0 z-50"),children:[e.jsxs("div",{className:"h-14 border-b border-border flex items-center px-4 bg-card/50",children:[e.jsx(p,{variant:"ghost",size:"icon",className:"mr-2",asChild:!0,children:e.jsx(K,{to:"/historify",children:e.jsx(gs,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ve,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Historify Charts"})]}),e.jsxs("div",{className:"flex items-center gap-3 ml-6",children:[e.jsxs(ss,{open:ke,onOpenChange:le,children:[e.jsx(ts,{asChild:!0,children:e.jsxs(p,{variant:"outline",className:"w-64 justify-between",children:[o?e.jsxs("span",{children:[o,":",l]}):e.jsx("span",{className:"text-muted-foreground",children:"Select symbol..."}),e.jsx(fs,{className:"h-4 w-4 ml-2"})]})}),e.jsx(as,{className:"w-64 p-0",align:"start",children:e.jsxs(rs,{children:[e.jsx(ns,{placeholder:"Search symbols...",value:T,onValueChange:ce}),e.jsxs(os,{children:[e.jsx(ls,{children:"No symbols found"}),e.jsx(cs,{children:Pe.slice(0,20).map(s=>e.jsxs(is,{value:`${s.symbol}:${s.exchange}`,onSelect:()=>Ye(s.symbol,s.exchange),children:[e.jsx("span",{className:"font-medium",children:s.symbol}),e.jsx(R,{variant:"outline",className:"ml-2 text-[10px]",children:s.exchange}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-auto",children:[s.intervals.length," intervals"]})]},`${s.symbol}:${s.exchange}`))})]})]})})]}),e.jsxs(ge,{value:x?"custom":m,onValueChange:s=>{s==="custom"?ie(!0):(ie(!1),Te(s))},children:[e.jsx(fe,{className:"w-24",children:e.jsx(pe,{})}),e.jsxs(je,{children:[Ve.map(s=>e.jsx(j,{value:s,children:s},s)),e.jsx(j,{value:"custom",children:"Custom"})]})]}),x&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Z,{type:"number",min:"1",max:"999",value:k,onChange:s=>ze(s.target.value),className:"h-9 w-14 text-center",placeholder:"1"}),e.jsxs(ge,{value:d,onValueChange:s=>Ee(s),children:[e.jsx(fe,{className:"w-20 h-9",children:e.jsx(pe,{})}),e.jsxs(je,{children:[e.jsx(j,{value:"m",children:"min"}),e.jsx(j,{value:"h",children:"hr"}),e.jsx(j,{value:"W",children:"Week"}),e.jsx(j,{value:"MO",children:"Month"}),e.jsx(j,{value:"Q",children:"Qtr"}),e.jsx(j,{value:"Y",children:"Year"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ps,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(Z,{type:"date",value:H,onChange:s=>$e(s.target.value),className:"h-9 w-36"}),e.jsx("span",{className:"text-muted-foreground",children:"-"}),e.jsx(Z,{type:"date",value:W,onChange:s=>Fe(s.target.value),className:"h-9 w-36"})]}),e.jsx(p,{variant:"outline",size:"icon",onClick:me,disabled:ne,children:e.jsx(js,{className:J("h-4 w-4",ne&&"animate-spin")})})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[A?.broker&&e.jsx(R,{variant:"outline",className:"text-xs",children:A.broker.toUpperCase()}),e.jsxs(R,{variant:h==="live"?"default":"secondary",className:J("text-xs cursor-pointer",h==="analyzer"&&"bg-purple-500 hover:bg-purple-600 text-white"),onClick:re,children:[h==="live"?e.jsx(Se,{className:"h-3 w-3 mr-1"}):e.jsx(be,{className:"h-3 w-3 mr-1"}),h==="live"?"Live":"Analyze"]}),e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:re,disabled:X,title:`Switch to ${h==="live"?"Analyze":"Live"} mode`,children:X?e.jsx(vs,{className:"h-4 w-4 animate-spin"}):h==="live"?e.jsx(Se,{className:"h-4 w-4"}):e.jsx(be,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:Ne,disabled:h!=="live",title:U==="light"?"Switch to dark mode":"Switch to light mode",children:U==="light"?e.jsx(Ss,{className:"h-4 w-4"}):e.jsx(bs,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",onClick:_e,children:V?e.jsx(Ns,{className:"h-4 w-4"}):e.jsx(ws,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"sm",className:"h-8 text-xs",asChild:!0,children:e.jsxs(K,{to:"/dashboard",children:[e.jsx(ys,{className:"h-4 w-4 mr-1.5"}),"Dashboard"]})}),e.jsxs(Qe,{children:[e.jsx(Je,{asChild:!0,children:e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full bg-primary text-primary-foreground",children:e.jsx("span",{className:"text-sm font-medium",children:A?.username?.[0]?.toUpperCase()||"O"})})}),e.jsxs(Ge,{align:"end",className:"w-56",children:[Ze.map(s=>e.jsxs(G,{onSelect:()=>O(s.href),className:"cursor-pointer",children:[e.jsx(s.icon,{className:"h-4 w-4 mr-2"}),s.label]},s.href)),e.jsx(G,{asChild:!0,children:e.jsxs("a",{href:"https://docs.openalgo.in",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2",children:[e.jsx(Cs,{className:"h-4 w-4"}),"Docs"]})}),e.jsx(Ke,{}),e.jsxs(G,{onClick:()=>se(!0),className:"text-destructive focus:text-destructive",children:[e.jsx(Ds,{className:"h-4 w-4 mr-2"}),"Logout"]})]})]})]})]}),e.jsx(Xe,{open:ye,onOpenChange:se,onConfirm:De}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden p-4",children:o?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold",children:[o,":",l]}),e.jsx(R,{variant:"outline",children:m}),r.length>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:[r.length.toLocaleString()," candles"]})]}),z&&e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Data: ",z.first_date," - ",z.last_date]}),e.jsxs("span",{children:[z.record_count.toLocaleString()," records stored"]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 border rounded-lg bg-card overflow-hidden relative",children:e.jsx("div",{ref:g,className:"absolute inset-0"})}),r.length>0&&e.jsxs("div",{className:"mt-3 grid grid-cols-5 gap-4",children:[e.jsx(L,{children:e.jsxs(I,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Open"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.open?.toFixed(2)})]})}),e.jsx(L,{children:e.jsxs(I,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"High"}),e.jsx("div",{className:"text-lg font-medium text-green-600",children:r[r.length-1]?.high?.toFixed(2)})]})}),e.jsx(L,{children:e.jsxs(I,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Low"}),e.jsx("div",{className:"text-lg font-medium text-red-600",children:r[r.length-1]?.low?.toFixed(2)})]})}),e.jsx(L,{children:e.jsxs(I,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Close"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.close?.toFixed(2)})]})}),e.jsx(L,{children:e.jsxs(I,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Volume"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.volume?.toLocaleString()})]})})]})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(ve,{className:"h-16 w-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-xl font-medium",children:"Select a Symbol"}),e.jsx("p",{className:"text-sm mt-2",children:"Choose a symbol from your data catalog to view its chart"}),D.length===0&&e.jsxs("p",{className:"text-sm mt-4",children:["No data in catalog."," ",e.jsx(K,{to:"/historify",className:"text-primary underline",children:"Download data first"})]})]})})})]})}export{Ps as default};
